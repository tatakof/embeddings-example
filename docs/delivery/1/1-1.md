# 1-1 Create `/api/chat` route

## Description
Implement a Next.js route handler that accepts conversation history, new message, provider and dimension, calls `/api/query` to retrieve context, constructs a prompt with memory, invokes Surus (or OpenAI) chat completions, and streams the response with citations.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-07-05 00:00:00 | Created | N/A | Proposed | Task file created | assistant |
| 2025-07-05 00:01:00 | Status Update | Proposed | Agreed | User approved task list | user |
| 2025-07-05 00:02:00 | Status Update | Agreed | InProgress | Started implementation of chat route | assistant |
| 2025-07-05 00:05:00 | Status Update | InProgress | Review | Implementation complete, awaiting validation | assistant |
| 2025-07-05 00:15:00 | Status Update | Review | Done | Backend route validated by user | assistant |

## Requirements
- POST `/api/chat`.
- Accept payload `{ conversation: Message[], newMessage: string, provider?: string, dimension?: number }`.
- Retain last 6 user+assistant messages (max 1000 tokens).
- Retrieve context by internally calling `/api/query` with the new user message.
- Compose prompt `[system] + memory + context + user`.
- Stream response back to client; include `sources` from retrieval.

## Implementation Plan
1. Create route `app/api/chat/route.ts` using similar pattern as existing routes.
2. Input validation & memory truncation.
3. Internal fetch to `/api/query`.
4. Build prompt and call Surus chat completions.
5. Stream reply via `NextResponse` and `ReadableStream`.
6. Unit-test prompt builder and memory slicing.

## Verification
- Unit test memory utility functions.
- Integration test: index sample doc, then chat two turns, expect 200 and citations.

## Files Modified
app/api/chat/route.ts
app/lib/prompt.ts (new)
test/integration/chat.spec.ts
[Back to task list](./tasks.md) 